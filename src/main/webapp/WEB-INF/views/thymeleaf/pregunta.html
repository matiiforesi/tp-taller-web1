<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Pregunta</title>
    <!-- Boostrap CSS -->
    <link rel="stylesheet" th:href="@{/webjars/bootstrap/5.2.0/css/bootstrap.min.css}"/>
    <!-- Estilos -->
    <link rel="stylesheet" th:href="@{/css/colores.css}"/>
    <link rel="stylesheet" th:href="@{/css/pregunta.css}">
</head>
<body>

<div class="contenedor_general w-100">
    <div id="contenedor-pregunta">
        <div class="d-flex justify-content-around mb-4">

            <!-- TIEMPO -->
            <div class="card text-center shadow-sm card-metrica">
                <div class="card-body">
                    <img th:src="@{/img/clock_6626437.png}" alt="tiempo">
                    <h6 class="card-title">Tiempo</h6>
                    <span id="timer" th:text="${tiempoRestante}" class="fs-4"></span>s
                </div>
            </div>

            <!-- VIDAS -->
            <div class="card text-center shadow-sm card-metrica">
                <div class="card-body">
                    <img th:src="@{/img/heart_2630121.png}" alt="vidas">
                    <h6 class="card-title">Vidas</h6>
                    <span th:text="${vidasRestantes}" class="fs-4"></span>
                </div>
            </div>

            <!-- PUNTAJE -->
            <div class="card text-center shadow-sm card-metrica">
                <div class="card-body">
                    <img th:src="@{/img/star_1965098.png}" alt="puntos">
                    <h6 class="card-title" style="color:black;">Puntaje</h6>
                    <span th:text="${puntajeTotal}" class="fs-4"></span>
                </div>
            </div>

            <!-- MONEDAS -->
            <div class="card text-center shadow-sm card-metrica">
                <div class="card-body">
                    <img th:src="@{/img/coin_7163342.png}" alt="monedas">
                    <h6 class="card-title"> Monedas</h6>
                    <span th:text="${monedas}" class="fs-4"></span>
                </div>
            </div>
        </div>

        <div class="alert alert-pregunta text-center shadow-sm fs-4 fw-bold">
            <h2 th:text="${pregunta.enunciado}"></h2>
        </div>

        <form id="formulario" th:if="${!respondida}"
              th:action="@{'/juego/' + ${cuestionario.id} + '/validar'}"
              method="post"
              accept-charset="UTF-8">
            <input type="hidden" name="idPregunta" th:value="${pregunta.id}"/>

            <div class="mb-3 ayudas-container" th:if="${ayudasDisponibles!=null and !ayudasDisponibles.isEmpty()}">
                <label class="form-label fw-bold">¿Querés usar una ayuda?</label>
                <div class="row g-3">

                    <!-- SIN AYUDA (predeterminado) -->
                    <div class="col-md-4">
                        <input type="radio" class="btn-check" name="trampaActivada" id="sinAyuda" value=""
                               th:checked="${trampaUsada == null}">
                        <label class="card btn btn-ayuda btn-ayuda-sin w-100" for="sinAyuda">
                            <div class="card-body text-center">
                                Sin ayuda
                            </div>
                        </label>
                    </div>

                    <!-- DUPLICAR PUNTAJE -->
                    <div class="col-md-4">
                        <input type="radio" class="btn-check" name="trampaActivada" id="duplicar"
                               value="DUPLICAR_PUNTAJE"
                               th:checked="${trampaUsada == 'DUPLICAR_PUNTAJE'}"
                               th:disabled="${duplicar_puntaje == 0}">
                        <label class="card btn btn-ayuda btn-ayuda-duplicar w-100" for="duplicar">
                            <div class="card-body text-center">
                                Duplicar
                                <small>(<strong th:text="${duplicar_puntaje}"></strong>)</small>
                            </div>
                        </label>
                    </div>

                    <!-- ELIMINAR DOS INCORRECTAS -->
                    <div class="col-md-4">
                        <input type="radio" class="btn-check" name="trampaActivada" id="eliminar"
                               value="ELIMINAR_DOS_INCORRECTAS"
                               th:checked="${trampaUsada == 'ELIMINAR_DOS_INCORRECTAS'}"
                               th:disabled="${eliminar_incorrectas == 0}">
                        <label class="card btn btn-ayuda btn-ayuda-eliminar w-100" for="eliminar">
                            <div class="card-body text-center">
                                Bomba
                                <small>(<strong th:text="${eliminar_incorrectas}"></strong>)</small>
                            </div>
                        </label>
                    </div>
                </div>
            </div>

            <div class="d-grid gap-3">
                <button type="submit" name="respuesta" th:value="${opcion}"
                        th:each="opcion : ${opciones}"
                        class="btn btn-respuesta btn-lg">
                    <span th:text="${opcion}"></span>
                </button>
            </div>
        </form>

        <!-- RESPUESTAS -->
        <div th:if="${respondida}">

            <!-- TIEMPO AGOTADO -->
            <div th:if="${tiempoAgotado}"
                 style="color: orange; font-weight: bold; border: 2px solid orange; padding: 20px; border-radius: 8px; background-color: #fff3cd;"
                 class="d-flex align-items-center justify-content-center flex-column">
                <h4>¡Se agotó el tiempo!</h4>
                <form th:action="@{/siguiente}" method="post">
                    <button type="submit" class="btn btn-warning">Siguiente</button>
                </form>
            </div>

            <!-- CORRECTA -->
            <div th:if="${!tiempoAgotado and esCorrecta}"
                 style="color: #155724; font-weight: bold; border: 2px solid #28a745; padding: 20px; border-radius: 8px; background-color: #d4edda;"
                 class="d-flex align-items-center justify-content-center flex-column">
                <h4>¡Respuesta correcta!</h4>
                <form th:action="@{/siguiente}" method="post">
                    <button type="submit" class="btn btn-success">Siguiente</button>
                </form>
            </div>

            <!-- INCORRECTA -->
            <div th:if="${!tiempoAgotado and !esCorrecta}"
                 style="color: #721c24; font-weight: bold; border: 2px solid #dc3545; padding: 20px; border-radius: 8px; background-color: #f8d7da;"
                 class="d-flex align-items-center justify-content-center flex-column">
                <h4>¡Respuesta incorrecta!</h4>
                <form th:action="@{/siguiente}" method="post">
                    <button type="submit" class="btn btn-danger">Siguiente</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script th:inline="javascript">
    let tiempo = [[${tiempoRestante}]];
    const timerSpan = document.getElementById("timer");
    const form = document.getElementById("formulario");
    const respondida = [[${respondida}]];
    const idCuestionario = [[${cuestionario.id}]];
    const idPregunta = [[${pregunta.id}]];

    let isSubmitting = false;
    let isLeaving = false;

    if (!respondida) {
        document.querySelectorAll('form').forEach(function (formElement) {
            formElement.addEventListener('submit', function () {
                isSubmitting = true;
            });
        });

        document.addEventListener('keydown', function (e) {
            if (e.key === 'F5' || (e.ctrlKey && (e.key === 'r' || e.key === 'R'))) {
                e.preventDefault();
                if (confirm('¿Estás seguro de que quieres salir? Se perderá el progreso.')) {
                    isLeaving = true;
                    window.location.href = '/spring/home';
                }
            }
        });

        window.addEventListener('beforeunload', function (e) {
            if (!isSubmitting && !isLeaving) {
                e.preventDefault();
                e.returnValue = '¿Estás seguro de que quieres salir? Se perderá el progreso.';
                return e.returnValue;
            }
        });
    }

    if (!respondida) {
        const interval = setInterval(() => {
            tiempo--;
            timerSpan.textContent = tiempo;

            if (tiempo <= 0) {
                clearInterval(interval);

                if (form) form.style.display = "none";

                isSubmitting = true;

                const tempForm = document.createElement("form");
                tempForm.method = "POST";
                tempForm.action = `/spring/juego/${idCuestionario}/validar`;

                const inputPregunta = document.createElement("input");
                inputPregunta.type = "hidden";
                inputPregunta.name = "idPregunta";
                inputPregunta.value = idPregunta;

                const inputRespuesta = document.createElement("input");
                inputRespuesta.type = "hidden";
                inputRespuesta.name = "respuesta";
                inputRespuesta.value = "";

                const inputTiempo = document.createElement("input");
                inputTiempo.type = "hidden";
                inputTiempo.name = "tiempoAgotado";
                inputTiempo.value = "true";

                tempForm.appendChild(inputPregunta);
                tempForm.appendChild(inputRespuesta);
                tempForm.appendChild(inputTiempo);

                document.body.appendChild(tempForm);
                tempForm.submit();
            }
        }, 1000);
    }
    document.querySelectorAll("input[name='trampaActivada']").forEach(radio => {
        radio.addEventListener("change", async function () {
            const tipoTrampa = this.value;

            if (tipoTrampa === "ELIMINAR_DOS_INCORRECTAS") {
                const idPregunta = document.querySelector("input[name='idPregunta']").value;
                const idUsuario = [[${usuario.id}]];

                const response = await fetch("/spring/juego/opciones-filtradas", {
                    method: "POST",
                    headers: {"Content-Type": "application/x-www-form-urlencoded"},
                    body: new URLSearchParams({
                        idPregunta: idPregunta,
                        idUsuario: idUsuario,
                        trampaActivada: tipoTrampa
                    })
                });

                const opciones = await response.json();
                const contenedor = document.querySelector(".d-grid");
                contenedor.innerHTML = "";

                opciones.forEach(opcion => {
                    const button = document.createElement("button");
                    button.type = "submit";
                    button.name = "respuesta";
                    button.value = opcion;
                    button.className = "btn btn-respuesta btn-lg";
                    button.innerHTML = `<span>${opcion}</span>`;
                    contenedor.appendChild(button);
                });

                const mensaje = document.createElement("div");
                mensaje.className = "alert alert-warning mt-3";
                mensaje.innerHTML = "Se eliminaron dos opciones incorrectas.";
                document.getElementById("contenedor-pregunta").appendChild(mensaje);
            }
        });
    });
</script>

</body>
</html>